<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cozmo.github.io/jsQR/jsQR.js"></script>
</head>
<body>
    <canvas id="canvasElement" hidden></canvas>
    <!-- <video></video> -->
    <img id="answerQR"/>
    <script>

    </script>
    <script>
    var video = document.createElement("video");
    var canvas = canvasElement.getContext("2d");
    navigator.mediaDevices.getUserMedia({ audio: true, video: { facingMode: "environment" } })
        .then(function(mediaStream) {
            video.srcObject = mediaStream;
            video.setAttribute("playsinline", true); // required to tell iOS safari we don't want fullscreen
            video.play();
            requestAnimationFrame(tick);
            /* 使用这个 stream stream */
        })
        .catch(function(err) {
        /* 处理 error */
        console.error(err)
        });

    function drawLine(begin, end, color) {
        canvas.beginPath();
        canvas.moveTo(begin.x, begin.y);
        canvas.lineTo(end.x, end.y);
        canvas.lineWidth = 4;
        canvas.strokeStyle = color;
        canvas.stroke();
    }
    var lock = false

    function tick() {
      if (!lock && video.readyState === video.HAVE_ENOUGH_DATA) {
        canvasElement.hidden = false;

        canvasElement.height = video.videoHeight;
        canvasElement.width = video.videoWidth;
        canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
        var imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
        var code = jsQR(imageData.data, imageData.width, imageData.height, {
          inversionAttempts: "dontInvert",
        });
        if (code) {
          drawLine(code.location.topLeftCorner, code.location.topRightCorner, "#FF3B58");
          drawLine(code.location.topRightCorner, code.location.bottomRightCorner, "#FF3B58");
          drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, "#FF3B58");
          drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, "#FF3B58");
        //   outputData.innerText = code.data;
            let data = decodeURIComponent(code.data)
            if(/^(offer\:\/\/)/.test(data)){
                lock = true
                data = data.replace(/^(offer\:\/\/)/gi,"")
                connect(JSON.parse(data))
            }
        }
      }
      requestAnimationFrame(tick);
    }
    </script>
    <script>
        function connect(offer){
            console.log(offer)
            remoteConnection = new RTCPeerConnection();
            remoteConnection.ondatachannel = (e)=>{
                console.log("ondatachannel:",e)
                receiveChannel = event.channel;
                receiveChannel.onmessage = (e)=>{console.log("onmessage",e)};
                receiveChannel.onopen = (e)=>{console.log("onopen",e)};
                receiveChannel.onclose = (e)=>{console.log("onclose",e)};
            }
            remoteConnection.onicecandidate=(e)=>{
                console.log(remoteConnection.iceGatheringState,"state")
                console.log(remoteConnection.localDescription)
                console.log(e)
                if(remoteConnection.iceGatheringState === "complete"){
                    window.answerQR.src = `https://chart.googleapis.com/chart?chs=300x300&cht=qr&chl=${encodeURIComponent('answer://' + JSON.stringify(remoteConnection.localDescription))}`
                }
            }
            remoteConnection.setRemoteDescription(offer)
                .then(res=>{
                    remoteConnection.createAnswer()
                    .then(answer=>remoteConnection.setLocalDescription(answer))
                })
        }
       
    </script>
</body>
</html>
